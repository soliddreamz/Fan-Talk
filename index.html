<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Fan Talk</title>

<style>
/* VISUALS ARE LOCKED — NO CHANGES */
body {
  margin: 0;
  background: #0b1020;
  color: #e8eef8;
  font-family: system-ui, -apple-system, sans-serif;
  text-align: center;
  padding: 20px;
}

.card {
  max-width: 420px;
  margin: auto;
}

button {
  padding: 14px 20px;
  margin: 8px;
  border-radius: 12px;
  border: none;
  background: #1f6feb;
  color: white;
  font-size: 16px;
}

button:disabled {
  opacity: 0.4;
}
</style>
</head>

<body>
<div class="card">

<h1>Fan Talk</h1>
<p>Talk like you’re speaking into a fan.</p>

<!-- FAN VISUAL — UNCHANGED -->
<img src="icon-192.png" style="width:120px;margin:20px auto;" alt="fan">

<div>
  <button id="recordBtn">Record</button>
  <button id="stopBtn" disabled>Stop</button>
</div>

<div>
  <button id="playBtn" disabled>Play</button>
</div>

</div>

<script>
let audioContext;
let mediaRecorder;
let chunks = [];
let recordedBuffer;

const recordBtn = document.getElementById("recordBtn");
const stopBtn = document.getElementById("stopBtn");
const playBtn = document.getElementById("playBtn");

recordBtn.onclick = async () => {
  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

  audioContext = new AudioContext();
  await audioContext.resume();

  mediaRecorder = new MediaRecorder(stream);
  chunks = [];

  mediaRecorder.ondataavailable = e => chunks.push(e.data);

  mediaRecorder.onstop = async () => {
    const blob = new Blob(chunks);
    const arrayBuffer = await blob.arrayBuffer();
    recordedBuffer = await audioContext.decodeAudioData(arrayBuffer);
    playBtn.disabled = false;
  };

  mediaRecorder.start();
  recordBtn.disabled = true;
  stopBtn.disabled = false;
};

stopBtn.onclick = () => {
  mediaRecorder.stop();
  recordBtn.disabled = false;
  stopBtn.disabled = true;
};

playBtn.onclick = () => {
  if (!recordedBuffer) return;

  const source = audioContext.createBufferSource();
  source.buffer = recordedBuffer;

  // FAN-STYLE FLUTTER (CONTROLLED)
  const lfo = audioContext.createOscillator();
  const lfoGain = audioContext.createGain();

  lfo.frequency.value = 14;        // realistic fan flutter speed
  lfoGain.gain.value = 0.015;      // VERY subtle (prevents distortion)

  lfo.connect(lfoGain);
  lfoGain.connect(source.playbackRate);

  // SOFTEN THE SOUND (FAN MUFFLE)
  const lowpass = audioContext.createBiquadFilter();
  lowpass.type = "lowpass";
  lowpass.frequency.value = 2500;

  // LOWER OVERALL GAIN
  const gain = audioContext.createGain();
  gain.gain.value = 0.6;

  source.connect(lowpass);
  lowpass.connect(gain);
  gain.connect(audioContext.destination);

  lfo.start();
  source.start();
};
</script>

</body>
</html>
