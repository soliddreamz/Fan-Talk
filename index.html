<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Fan Talk</title>
<link rel="manifest" href="manifest.json">

<style>
  :root{
    --bg1:#0c1c3a;
    --bg2:#050b18;
    --card:rgba(255,255,255,0.06);
    --text:#eaf1ff;
    --muted:rgba(234,241,255,0.72);
    --btn1:#3b82f6;
    --btn2:#2563eb;
    --btnDark:#101828;
    --stroke:rgba(255,255,255,0.10);
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    background:radial-gradient(circle at top, var(--bg1), var(--bg2));
    color:var(--text);
    font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    text-align:center;
    padding:18px 14px 22px;
  }
  .wrap{
    max-width:460px;
    margin:0 auto;
  }
  .card{
    background:var(--card);
    border:1px solid var(--stroke);
    border-radius:22px;
    padding:18px 16px 16px;
    box-shadow:0 18px 50px rgba(0,0,0,0.40);
    backdrop-filter: blur(10px);
  }
  .top{
    display:flex;
    justify-content:center;
    align-items:center;
    gap:10px;
    margin-bottom:6px;
  }
  .logo{
    width:min(240px, 82vw);
    height:auto;
    display:block;
    margin:2px auto 10px;
  }
  .desc{
    margin:6px auto 14px;
    color:var(--muted);
    font-size:14px;
    line-height:1.35;
  }

  /* Fan visual (logo NEVER goes here) */
  .fanStage{
    display:flex;
    justify-content:center;
    margin:10px 0 14px;
  }
  .fanRing{
    width:150px; height:150px;
    border-radius:999px;
    display:grid;
    place-items:center;
    background:radial-gradient(circle at 40% 35%, rgba(255,255,255,0.18), rgba(255,255,255,0.04) 55%, rgba(0,0,0,0.18));
    border:1px solid rgba(255,255,255,0.12);
    box-shadow: 0 0 40px rgba(59,130,246,0.22);
  }
  .fanSVG{
    width:128px; height:128px;
    transform-origin:50% 50%;
    animation:spin 1.4s linear infinite;
  }
  .spinSlow{ animation-duration:2.6s; }
  .spinMed{ animation-duration:1.35s; }
  .spinFast{ animation-duration:0.75s; }

  @keyframes spin {
    from { transform: rotate(0deg); }
    to   { transform: rotate(360deg); }
  }

  .row{ display:flex; flex-wrap:wrap; justify-content:center; gap:10px; }
  button{
    appearance:none;
    border:none;
    border-radius:14px;
    padding:13px 14px;
    min-width:140px;
    font-size:15px;
    font-weight:700;
    color:white;
    background:linear-gradient(135deg,var(--btn1),var(--btn2));
    box-shadow:0 10px 28px rgba(59,130,246,0.35);
  }
  button.secondary{
    background:linear-gradient(135deg,#172554,#0b1220);
    box-shadow:none;
    border:1px solid rgba(255,255,255,0.10);
  }
  button:disabled{ opacity:0.45; }
  button:active{ transform:scale(0.98); }

  .controls{
    margin-top:10px;
    display:grid;
    gap:10px;
  }
  .label{
    color:rgba(234,241,255,0.78);
    font-size:12px;
    text-align:left;
    margin:0 auto;
    width:min(360px, 92%);
  }
  select, input[type="range"]{
    width:min(360px, 92%);
    margin:0 auto;
    padding:12px 12px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,0.10);
    background:rgba(0,0,0,0.18);
    color:var(--text);
    outline:none;
  }
  input[type="range"]{ padding:10px 12px; }
  .status{
    margin-top:10px;
    color:rgba(234,241,255,0.72);
    font-size:13px;
    min-height:18px;
  }
  footer{
    margin-top:10px;
    color:rgba(234,241,255,0.55);
    font-size:11px;
  }

  /* subtle nostalgic overlay (safe) */
  body::after{
    content:"";
    position:fixed;
    inset:0;
    pointer-events:none;
    background:
      radial-gradient(circle at center, transparent 58%, rgba(0,0,0,0.35)),
      repeating-linear-gradient(to bottom,
        rgba(255,255,255,0.02), rgba(255,255,255,0.02) 1px,
        transparent 2px, transparent 4px
      );
    mix-blend-mode:overlay;
  }
</style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <!-- Logo stays at the top -->
      <img src="logo.png" class="logo" alt="Fan Talk logo" />

      <div class="desc">
        Talk into the mic like you‚Äôre talking through a fan. Record ‚Üí Play or Download.
      </div>

      <!-- Fan stays a fan (never the logo) -->
      <div class="fanStage">
        <div class="fanRing">
          <svg id="fanSVG" class="fanSVG spinMed" viewBox="0 0 100 100" aria-label="Fan animation">
            <circle cx="50" cy="50" r="6" fill="rgba(233,242,255,0.9)"/>
            <path d="M50 10 Q62 40 50 50 Q38 40 50 10Z" fill="rgba(59,130,246,0.95)"/>
            <path d="M90 50 Q60 62 50 50 Q60 38 90 50Z" fill="rgba(59,130,246,0.95)"/>
            <path d="M50 90 Q38 60 50 50 Q62 60 50 90Z" fill="rgba(59,130,246,0.95)"/>
            <path d="M10 50 Q40 38 50 50 Q40 62 10 50Z" fill="rgba(59,130,246,0.95)"/>
            <circle cx="50" cy="50" r="38" fill="none" stroke="rgba(255,255,255,0.18)" stroke-width="2"/>
          </svg>
        </div>
      </div>

      <div class="row">
        <button id="recordBtn">üéô Record</button>
        <button id="stopBtn" class="secondary" disabled>‚èπ Stop</button>
      </div>

      <div class="row">
        <button id="playBtn" disabled>‚ñ∂ Play</button>
        <button id="downloadBtn" class="secondary" disabled>‚¨á Download</button>
      </div>

      <div class="controls">
        <div class="label">Preset</div>
        <select id="preset">
          <option value="slow">Slow Fan ‚Äî Nostalgic</option>
          <option value="medium" selected>Medium Fan ‚Äî Classic</option>
          <option value="fast">Fast Fan ‚Äî Buzz</option>
        </select>

        <div class="label">Fan Intensity (more = stronger fan effect)</div>
        <input id="intensity" type="range" min="0.2" max="1.0" step="0.05" value="0.55" />
      </div>

      <div id="status" class="status">Ready.</div>
      <footer>On-device processing ¬∑ No uploads</footer>
    </div>
  </div>

<script>
/**
 * Fan Talk (Locked UI rules)
 * - Logo only at top (never used as fan)
 * - Fan SVG stays fan
 * - Copy/paste safe single-file
 *
 * Audio goals:
 * - Remove harsh distortion / clipping
 * - Make fan effect noticeable (tremolo + subtle flutter + tone shaping)
 * - Keep volume controlled (compressor + limiter-ish gain)
 */

let audioCtx = null;
let mediaStream = null;
let recorder = null;
let chunks = [];
let recordedBuffer = null;

// for fan reaction
let analyser = null;
let dataArray = null;
let rafId = null;

const recordBtn = document.getElementById('recordBtn');
const stopBtn = document.getElementById('stopBtn');
const playBtn = document.getElementById('playBtn');
const downloadBtn = document.getElementById('downloadBtn');
const presetSel = document.getElementById('preset');
const intensityEl = document.getElementById('intensity');
const statusEl = document.getElementById('status');
const fanSVG = document.getElementById('fanSVG');

function setStatus(t){ statusEl.textContent = t; }

function setFanPresetClass(){
  fanSVG.classList.remove('spinSlow','spinMed','spinFast');
  const p = presetSel.value;
  if(p === 'slow') fanSVG.classList.add('spinSlow');
  else if(p === 'fast') fanSVG.classList.add('spinFast');
  else fanSVG.classList.add('spinMed');
}
presetSel.addEventListener('change', setFanPresetClass);
setFanPresetClass();

async function ensureAudio(){
  if(!audioCtx){
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
  if(audioCtx.state === 'suspended'){
    await audioCtx.resume();
  }
  if(!mediaStream){
    mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
  }
}

function startFanMeter(){
  if(!audioCtx || !mediaStream) return;
  const src = audioCtx.createMediaStreamSource(mediaStream);
  analyser = audioCtx.createAnalyser();
  analyser.fftSize = 256;
  dataArray = new Uint8Array(analyser.frequencyBinCount);
  src.connect(analyser);

  const base = () => {
    const p = presetSel.value;
    return p === 'fast' ? 0.75 : (p === 'slow' ? 2.6 : 1.35);
  };

  const tick = () => {
    if(!analyser) return;
    analyser.getByteTimeDomainData(dataArray);
    let sum = 0;
    for(let i=0;i<dataArray.length;i++){
      const v = (dataArray[i]-128)/128;
      sum += v*v;
    }
    const rms = Math.sqrt(sum/dataArray.length); // ~0..1
    // make visible but not crazy
    const boost = Math.min(2.6, 1 + rms * 8);
    const dur = base() / boost;
    fanSVG.style.animationDuration = dur.toFixed(3) + 's';
    rafId = requestAnimationFrame(tick);
  };
  tick();
}

function stopFanMeter(){
  if(rafId) cancelAnimationFrame(rafId);
  rafId = null;
  analyser = null;
  dataArray = null;
  fanSVG.style.animationDuration = ''; // return to CSS
  setFanPresetClass();
}

recordBtn.addEventListener('click', async () => {
  try{
    setStatus('Requesting mic‚Ä¶');
    await ensureAudio();

    chunks = [];
    recorder = new MediaRecorder(mediaStream);
    recorder.ondataavailable = e => { if(e.data && e.data.size) chunks.push(e.data); };
    recorder.onstop = async () => {
      try{
        setStatus('Decoding audio‚Ä¶');
        const blob = new Blob(chunks);
        const ab = await blob.arrayBuffer();
        recordedBuffer = await audioCtx.decodeAudioData(ab);
        playBtn.disabled = false;
        downloadBtn.disabled = false;
        setStatus('Recorded. Tap Play or Download.');
      }catch(err){
        console.error(err);
        setStatus('Could not decode recording. Try again.');
      }
    };

    recorder.start();
    recordBtn.disabled = true;
    stopBtn.disabled = false;
    playBtn.disabled = true;
    downloadBtn.disabled = true;
    setStatus('Recording‚Ä¶');
    startFanMeter();
  }catch(err){
    console.error(err);
    setStatus('Mic blocked. Enable microphone for this site in Safari settings.');
  }
});

stopBtn.addEventListener('click', () => {
  if(recorder && recorder.state === 'recording'){
    recorder.stop();
  }
  recordBtn.disabled = false;
  stopBtn.disabled = true;
  setStatus('Stopping‚Ä¶');
  stopFanMeter();
});

/**
 * Build the fan effect chain:
 * - Tremolo (amplitude modulation) = classic fan ‚Äúchop‚Äù
 * - Subtle flutter (tiny delay modulation) = more natural fan warble (kept gentle)
 * - EQ shaping (lowpass + slight band emphasis)
 * - Compressor to prevent loud/distorted output
 */
function buildFanEffect(ctx, intensity, preset){
  const inputGain = ctx.createGain();
  inputGain.gain.value = 0.95; // headroom

  // Tone shaping
  const lowpass = ctx.createBiquadFilter();
  lowpass.type = 'lowpass';
  lowpass.frequency.value = preset === 'fast' ? 7000 : 8500;
  lowpass.Q.value = 0.7;

  const band = ctx.createBiquadFilter();
  band.type = 'bandpass';
  band.frequency.value = 900; // ‚Äúfan body‚Äù emphasis
  band.Q.value = 0.8;

  // Tremolo
  const tremGain = ctx.createGain();
  tremGain.gain.value = 1.0;

  const lfo = ctx.createOscillator();
  lfo.type = 'sine';
  const lfoGain = ctx.createGain();

  // fan speed rate
  const rate = preset === 'fast' ? 22 : (preset === 'slow' ? 8.5 : 14.5);
  lfo.frequency.value = rate;

  // Depth: keep noticeable but not harsh
  // We modulate gain around 1.0 with ¬±depth*0.55
  const depth = Math.min(1, Math.max(0.2, intensity)) * 0.55;
  lfoGain.gain.value = depth;

  // shift LFO to be positive (0..2) by setting base gain
  tremGain.gain.value = 1.0 - (depth * 0.5);

  lfo.connect(lfoGain);
  lfoGain.connect(tremGain.gain);

  // Subtle flutter with delay modulation (very small so it won‚Äôt get ‚Äúdistorted‚Äù)
  const delay = ctx.createDelay(0.02);
  delay.delayTime.value = 0.006;

  const flutter = ctx.createOscillator();
  flutter.type = 'sine';
  flutter.frequency.value = preset === 'fast' ? 5.5 : 4.2;

  const flutterGain = ctx.createGain();
  flutterGain.gain.value = 0.0018 * intensity; // tiny modulation

  flutter.connect(flutterGain);
  flutterGain.connect(delay.delayTime);

  // Compressor (prevents loud/harsh playback)
  const comp = ctx.createDynamicsCompressor();
  comp.threshold.value = -18;
  comp.knee.value = 18;
  comp.ratio.value = 3.2;
  comp.attack.value = 0.01;
  comp.release.value = 0.2;

  // Output gain (final trim)
  const outGain = ctx.createGain();
  outGain.gain.value = 0.9;

  return {
    inputGain, lowpass, band, delay, tremGain, comp, outGain,
    lfo, flutter,
    connect(source, destination){
      source.connect(inputGain);
      inputGain.connect(lowpass);
      lowpass.connect(band);
      band.connect(delay);
      delay.connect(tremGain);
      tremGain.connect(comp);
      comp.connect(outGain);
      outGain.connect(destination);
    },
    start(t){
      lfo.start(t);
      flutter.start(t);
    },
    stop(t){
      lfo.stop(t);
      flutter.stop(t);
    }
  };
}

playBtn.addEventListener('click', async () => {
  if(!recordedBuffer) return;
  await ensureAudio();

  setStatus('Playing‚Ä¶');

  const src = audioCtx.createBufferSource();
  src.buffer = recordedBuffer;

  const intensity = parseFloat(intensityEl.value);
  const preset = presetSel.value;

  const fx = buildFanEffect(audioCtx, intensity, preset);
  fx.connect(src, audioCtx.destination);
  fx.start(audioCtx.currentTime);

  src.start();
  src.onended = () => {
    try{ fx.stop(audioCtx.currentTime); }catch(e){}
    setStatus('Done.');
  };
});

/** Offline render for clean WAV download */
downloadBtn.addEventListener('click', async () => {
  if(!recordedBuffer) return;
  setStatus('Rendering WAV‚Ä¶');

  const preset = presetSel.value;
  const intensity = parseFloat(intensityEl.value);

  const sr = 44100;
  const len = Math.ceil(recordedBuffer.duration * sr);
  const off = new OfflineAudioContext(1, len, sr);

  // copy to mono for predictable WAV
  const mono = off.createBuffer(1, len, sr);
  const srcData = recordedBuffer.getChannelData(0);
  mono.copyToChannel(srcData, 0, 0);

  const src = off.createBufferSource();
  src.buffer = mono;

  const fx = buildFanEffect(off, intensity, preset);
  fx.connect(src, off.destination);
  src.start(0);
  fx.start(0);

  const rendered = await off.startRendering();
  const wavBlob = audioBufferToWavBlob(rendered);

  const url = URL.createObjectURL(wavBlob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'fan-talk.wav';
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);

  setStatus('Downloaded.');
});

function audioBufferToWavBlob(ab){
  const numCh = ab.numberOfChannels;
  const sampleRate = ab.sampleRate;
  const numFrames = ab.length;
  const bytesPerSample = 2;
  const blockAlign = numCh * bytesPerSample;
  const byteRate = sampleRate * blockAlign;
  const dataSize = numFrames * blockAlign;
  const buffer = new ArrayBuffer(44 + dataSize);
  const view = new DataView(buffer);

  let o = 0;
  function writeStr(s){
    for(let i=0;i<s.length;i++) view.setUint8(o++, s.charCodeAt(i));
  }
  writeStr('RIFF');
  view.setUint32(o, 36 + dataSize, true); o += 4;
  writeStr('WAVE');
  writeStr('fmt ');
  view.setUint32(o, 16, true); o += 4;        // PCM chunk size
  view.setUint16(o, 1, true); o += 2;         // PCM
  view.setUint16(o, numCh, true); o += 2;
  view.setUint32(o, sampleRate, true); o += 4;
  view.setUint32(o, byteRate, true); o += 4;
  view.setUint16(o, blockAlign, true); o += 2;
  view.setUint16(o, 16, true); o += 2;        // bits
  writeStr('data');
  view.setUint32(o, dataSize, true); o += 4;

  const chans = [];
  for(let c=0;c<numCh;c++) chans.push(ab.getChannelData(c));

  for(let i=0;i<numFrames;i++){
    for(let c=0;c<numCh;c++){
      let s = chans[c][i];
      s = Math.max(-1, Math.min(1, s));
      view.setInt16(o, s < 0 ? s * 0x8000 : s * 0x7FFF, true);
      o += 2;
    }
  }
  return new Blob([buffer], {type:'audio/wav'});
}
</script>
</body>
</html>
