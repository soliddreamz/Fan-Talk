<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Fan Talk</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#0b1020" />

  <style>
    :root{
      --bg1:#0c1b3a;
      --bg2:#050b18;
      --card:rgba(255,255,255,0.06);
      --text:#eaf1ff;
      --muted:rgba(234,241,255,0.75);
      --blue:#2f7cf6;
      --blue2:#2563eb;
      --slate:#1e293b;
      --shadow:0 18px 50px rgba(0,0,0,.45);
      --radius:20px;
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      min-height:100vh;
      background: radial-gradient(circle at top, var(--bg1), var(--bg2));
      color:var(--text);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      padding: 20px 14px 28px;
    }

    /* subtle nostalgia scanlines (very light) */
    body::after{
      content:"";
      position:fixed;
      inset:0;
      pointer-events:none;
      background:
        radial-gradient(circle at center, transparent 58%, rgba(0,0,0,.35)),
        repeating-linear-gradient(to bottom,
          rgba(255,255,255,.02),
          rgba(255,255,255,.02) 1px,
          transparent 2px,
          transparent 5px);
      mix-blend-mode: overlay;
      opacity:.7;
    }

    .card{
      width:min(440px, 100%);
      background: var(--card);
      border-radius: var(--radius);
      padding: 18px 16px 16px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      position:relative;
      overflow:hidden;
    }

    .top{
      display:flex;
      justify-content:center;
      align-items:center;
      margin-top: 6px;
      margin-bottom: 10px;
    }

    /* LOGO fits phone: no overflow */
    .logo{
      width: min(240px, 80vw);
      height:auto;
      display:block;
      filter: drop-shadow(0 10px 20px rgba(0,0,0,.35));
    }

    .subtitle{
      margin: 8px auto 6px;
      color: var(--muted);
      font-size: 14px;
      line-height:1.35;
      max-width: 34ch;
      text-align:center;
    }

    .fanWrap{
      display:flex;
      justify-content:center;
      margin: 14px 0 10px;
    }

    /* Fan SVG container */
    .fan{
      width: 150px;
      height: 150px;
      display:block;
      filter: drop-shadow(0 12px 22px rgba(0,0,0,.35));
    }

    /* Only blades spin */
    .blades{
      transform-origin: 50px 50px;
      animation: spin 1.4s linear infinite;
    }

    @keyframes spin{
      from{ transform: rotate(0deg); }
      to{ transform: rotate(360deg); }
    }

    .row{
      display:flex;
      gap:10px;
      justify-content:center;
      flex-wrap:wrap;
      margin-top: 6px;
    }

    button{
      border:none;
      border-radius: 14px;
      padding: 12px 14px;
      font-size: 16px;
      font-weight: 650;
      color:white;
      background: linear-gradient(135deg, var(--blue), var(--blue2));
      box-shadow: 0 10px 24px rgba(47,124,246,.35);
      min-width: 150px;
    }
    button.secondary{
      background: #17233a;
      box-shadow: 0 10px 24px rgba(0,0,0,.25);
    }
    button:disabled{ opacity:.45; }

    button:active{ transform: scale(.98); }

    .controls{
      margin-top: 10px;
    }

    label{
      display:block;
      margin: 12px auto 6px;
      color: var(--muted);
      font-size: 13px;
      text-align:left;
      max-width: 360px;
    }

    select, input[type="range"]{
      width: 100%;
      max-width: 360px;
      margin: 0 auto;
      display:block;
    }

    select{
      background: rgba(0,0,0,.25);
      border: 1px solid rgba(255,255,255,.12);
      color: var(--text);
      padding: 12px 12px;
      border-radius: 14px;
      font-size: 15px;
      outline:none;
    }

    input[type="range"]{
      margin-top: 8px;
    }

    .status{
      margin-top: 12px;
      font-size: 13px;
      color: var(--muted);
      min-height: 18px;
    }

    footer{
      margin-top: 14px;
      font-size: 11px;
      color: rgba(234,241,255,.55);
    }
  </style>
</head>

<body>
  <div class="card">
    <!-- Logo replaces title text -->
    <div class="top">
      <img src="logo.png" class="logo" alt="Fan Talk logo" />
    </div>

    <div class="subtitle">Talk into the mic like you're talking through a fan.</div>

    <!-- Real fan (SVG), blades spin + react to voice -->
    <div class="fanWrap">
      <svg class="fan" viewBox="0 0 100 100" aria-label="Spinning fan">
        <!-- fan body -->
        <circle cx="50" cy="50" r="45" fill="rgba(255,255,255,0.07)" />
        <circle cx="50" cy="50" r="38" fill="rgba(47,124,246,0.15)" />
        <circle cx="50" cy="50" r="6" fill="rgba(234,241,255,0.85)" />

        <!-- grill lines -->
        <g stroke="rgba(234,241,255,0.18)" stroke-width="1">
          <circle cx="50" cy="50" r="14" fill="none"/>
          <circle cx="50" cy="50" r="22" fill="none"/>
          <circle cx="50" cy="50" r="30" fill="none"/>
          <circle cx="50" cy="50" r="36" fill="none"/>
          <line x1="50" y1="12" x2="50" y2="88"/>
          <line x1="12" y1="50" x2="88" y2="50"/>
          <line x1="22" y1="22" x2="78" y2="78"/>
          <line x1="78" y1="22" x2="22" y2="78"/>
        </g>

        <!-- blades (spin this group only) -->
        <g class="blades" id="blades">
          <path d="M50 50 C64 36 74 30 78 34 C82 38 72 48 58 58 C54 62 46 58 50 50Z" fill="rgba(47,124,246,0.9)"/>
          <path d="M50 50 C36 64 30 74 34 78 C38 82 48 72 58 58 C62 54 58 46 50 50Z" fill="rgba(47,124,246,0.75)"/>
          <path d="M50 50 C34 36 26 30 22 34 C18 38 28 48 42 58 C46 62 54 58 50 50Z" fill="rgba(47,124,246,0.65)"/>
        </g>
      </svg>
    </div>

    <div class="row">
      <button id="recordBtn">üéô Record</button>
      <button id="stopBtn" class="secondary" disabled>‚èπ Stop</button>
    </div>

    <div class="row">
      <button id="playBtn" disabled>‚ñ∂ Play</button>
      <button id="downloadBtn" class="secondary" disabled>‚¨á Download WAV</button>
    </div>

    <div class="controls">
      <label for="preset">Preset</label>
      <select id="preset">
        <option value="slow">Slow Fan ‚Äî Nostalgic</option>
        <option value="medium" selected>Medium Fan ‚Äî Classic</option>
        <option value="fast">Fast Fan ‚Äî Buzz</option>
      </select>

      <label for="sensitivity">Voice reaction (sensitivity)</label>
      <input id="sensitivity" type="range" min="0.6" max="3.0" step="0.1" value="1.5">
    </div>

    <div class="status" id="status">Ready.</div>
    <footer>On-device audio only ¬∑ Nothing uploaded</footer>
  </div>

<script>
  let audioContext, mediaRecorder, chunks = [];
  let recordedBuffer = null;

  // mic visual analyser
  let analyser = null, dataArray = null, rafId = null;

  const recordBtn = document.getElementById("recordBtn");
  const stopBtn = document.getElementById("stopBtn");
  const playBtn = document.getElementById("playBtn");
  const downloadBtn = document.getElementById("downloadBtn");
  const preset = document.getElementById("preset");
  const sensitivity = document.getElementById("sensitivity");
  const statusEl = document.getElementById("status");
  const blades = document.getElementById("blades");

  function baseSpinSeconds() {
    if (preset.value === "fast") return 0.65;
    if (preset.value === "slow") return 2.4;
    return 1.25;
  }

  function setSpin(seconds) {
    blades.style.animationDuration = `${seconds}s`;
  }

  preset.addEventListener("change", () => setSpin(baseSpinSeconds()));

  function stopVisualLoop() {
    if (rafId) cancelAnimationFrame(rafId);
    rafId = null;
  }

  function visualLoop() {
    if (!analyser || !dataArray) return;

    analyser.getByteTimeDomainData(dataArray);

    // RMS volume
    let sum = 0;
    for (let i = 0; i < dataArray.length; i++) {
      const v = (dataArray[i] - 128) / 128;
      sum += v * v;
    }
    const rms = Math.sqrt(sum / dataArray.length);

    const sens = Number(sensitivity.value);
    const boost = Math.min(3.2, 1 + rms * 9 * sens);

    const base = baseSpinSeconds();
    const next = Math.max(0.25, base / boost);

    setSpin(next);

    rafId = requestAnimationFrame(visualLoop);
  }

  recordBtn.onclick = async () => {
    try {
      statusEl.textContent = "Requesting microphone‚Ä¶";

      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

      audioContext = new (window.AudioContext || window.webkitAudioContext)();
      await audioContext.resume();

      // analyser for voice-reactive fan
      const mic = audioContext.createMediaStreamSource(stream);
      analyser = audioContext.createAnalyser();
      analyser.fftSize = 256;
      dataArray = new Uint8Array(analyser.frequencyBinCount);
      mic.connect(analyser);

      // recorder
      mediaRecorder = new MediaRecorder(stream);
      chunks = [];

      mediaRecorder.ondataavailable = (e) => { if (e.data && e.data.size) chunks.push(e.data); };

      mediaRecorder.onstop = async () => {
        try {
          statusEl.textContent = "Processing‚Ä¶";
          const blob = new Blob(chunks);
          const buf = await blob.arrayBuffer();
          recordedBuffer = await audioContext.decodeAudioData(buf);

          playBtn.disabled = false;
          downloadBtn.disabled = false;
          statusEl.textContent = "Recorded. Press Play or Download.";
        } catch (err) {
          statusEl.textContent = "Couldn‚Äôt process audio. Try again.";
          console.error(err);
        }
      };

      mediaRecorder.start();

      recordBtn.disabled = true;
      stopBtn.disabled = false;
      playBtn.disabled = true;
      downloadBtn.disabled = true;

      setSpin(baseSpinSeconds());
      stopVisualLoop();
      visualLoop();

      statusEl.textContent = "Recording‚Ä¶";
    } catch (err) {
      console.error(err);
      statusEl.textContent = "Mic blocked. In Safari: aA ‚Üí Website Settings ‚Üí Microphone ‚Üí Allow.";
    }
  };

  stopBtn.onclick = () => {
    try {
      if (mediaRecorder && mediaRecorder.state === "recording") mediaRecorder.stop();
      recordBtn.disabled = false;
      stopBtn.disabled = true;
      statusEl.textContent = "Stopped.";
      // keep visual loop until page refresh; you can stop it if you want:
      stopVisualLoop();
      setSpin(baseSpinSeconds());
    } catch (err) {
      console.error(err);
    }
  };

  playBtn.onclick = async () => {
    if (!recordedBuffer || !audioContext) return;

    // iOS can suspend context; resume on user gesture
    if (audioContext.state === "suspended") await audioContext.resume();

    // apply a light ‚Äúfan‚Äù wobble using playbackRate modulation (simple + stable)
    const src = audioContext.createBufferSource();
    src.buffer = recordedBuffer;

    const lfo = audioContext.createOscillator();
    const lfoGain = audioContext.createGain();

    // preset-dependent wobble rate
    lfo.frequency.value = preset.value === "fast" ? 22 : (preset.value === "slow" ? 8 : 14);
    lfoGain.gain.value = 0.03; // subtle

    lfo.connect(lfoGain);
    lfoGain.connect(src.playbackRate);

    src.connect(audioContext.destination);

    lfo.start();
    src.start();

    src.onended = () => {
      try { lfo.stop(); } catch {}
    };

    statusEl.textContent = "Playing‚Ä¶";
  };

  downloadBtn.onclick = () => {
    if (!recordedBuffer) return;
    const wav = audioBufferToWav(recordedBuffer);
    const blob = new Blob([wav], { type: "audio/wav" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "fan-talk.wav";
    a.click();

    setTimeout(() => URL.revokeObjectURL(url), 1500);
    statusEl.textContent = "Downloaded.";
  };

  function audioBufferToWav(buffer) {
    const numCh = buffer.numberOfChannels;
    const sampleRate = buffer.sampleRate;
    const length = buffer.length * numCh * 2 + 44;
    const ab = new ArrayBuffer(length);
    const view = new DataView(ab);

    let offset = 0;
    const writeStr = (s) => { for (let i=0;i<s.length;i++) view.setUint8(offset++, s.charCodeAt(i)); };

    writeStr("RIFF");
    view.setUint32(offset, 36 + buffer.length * numCh * 2, true); offset += 4;
    writeStr("WAVE");
    writeStr("fmt ");
    view.setUint32(offset, 16, true); offset += 4;
    view.setUint16(offset, 1, true); offset += 2;
    view.setUint16(offset, numCh, true); offset += 2;
    view.setUint32(offset, sampleRate, true); offset += 4;
    view.setUint32(offset, sampleRate * numCh * 2, true); offset += 4;
    view.setUint16(offset, numCh * 2, true); offset += 2;
    view.setUint16(offset, 16, true); offset += 2;
    writeStr("data");
    view.setUint32(offset, buffer.length * numCh * 2, true); offset += 4;

    // interleave
    const chans = [];
    for (let c=0;c<numCh;c++) chans.push(buffer.getChannelData(c));

    for (let i=0;i<buffer.length;i++){
      for (let c=0;c<numCh;c++){
        let s = Math.max(-1, Math.min(1, chans[c][i]));
        view.setInt16(offset, s < 0 ? s * 0x8000 : s * 0x7FFF, true);
        offset += 2;
      }
    }
    return ab;
  }

  // initial spin speed
  setSpin(baseSpinSeconds());
</script>
</body>
</html>
